<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoVault Multi-Stage Tester</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 650px; margin: 2rem auto; background-color: #f8f9fa; color: #333; }
        .card { background: white; padding: 20px; margin-bottom: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        input[type="text"], input[type="file"] { width: 100%; padding: 12px; margin-top: 8px; border: 1px solid #dfe3e6; border-radius: 6px; box-sizing: border-box; }
        
        .btn-group { display: flex; gap: 10px; margin-top: 15px; }
        button { flex: 1; padding: 14px; border-radius: 6px; cursor: pointer; font-weight: 600; border: none; transition: all 0.2s; }
        
        #healthBtn { background-color: #47cc40; color: white; }
        #sessionBtn, #getDownloadUrlBtn { background-color: #007bff; color: white; }
        #uploadBtn, #executeDownloadBtn { background-color: #238636; color: white; }
        
        button:disabled { background-color: #ccc !important; cursor: not-allowed; opacity: 0.6; }
        button:hover:not(:disabled) { opacity: 0.9; transform: translateY(-1px); }

        progress { width: 100%; height: 20px; margin-top: 10px; accent-color: #238636; }
        #log { background: #161b22; color: #d1d5da; padding: 15px; font-family: 'Cascadia Code', monospace; font-size: 12px; height: 220px; overflow-y: auto; border-radius: 6px; margin-top: 10px; border: 1px solid #30363d; }
        .err { color: #f85149; }
        .info { color: #79c0ff; }
        .success { color: #51cf66; }
        label { font-weight: 600; font-size: 14px; color: #444; }
        .step-label { display: inline-block; background: #eee; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-bottom: 5px; }
        hr { border: 0; border-top: 1px solid #eee; margin: 20px 0; }
    </style>
</head>
<body>

    <div class="card">
        <h2>GoVault Credentials</h2>
        <label>Access Token (JWT)</label>
        <input type="text" id="token" placeholder="Bearer token...">
        <div class="btn-group">
            <button id="healthBtn">Check Health</button>
        </div>
    </div>

    <div class="card">
        <h3>Upload Flow</h3>
        <span class="step-label">STAGE 1</span><br>
        <label>Select File</label>
        <input type="file" id="fileInput">
        <button id="sessionBtn">Initialize Session</button>
        <hr>
        <span class="step-label">STAGE 2</span><br>
        <div id="sessionInfo" style="font-size: 12px; color: #666; margin-bottom: 10px;">No active session</div>
        <button id="uploadBtn" disabled>Start Uploading Chunks</button>
        <progress id="progressBar" value="0" max="100"></progress>
    </div>

    <div class="card">
        <h3>Download Flow</h3>
        <span class="step-label">STAGE 1</span><br>
        <label>File UUID</label>
        <input type="text" id="downloadFileId" placeholder="Enter File UUID (e.g. 550e8400-e29b...)">
        <button id="getDownloadUrlBtn">Get S3 Download URL</button>
        <hr>
        <span class="step-label">STAGE 2</span><br>
        <div id="downloadUrlInfo" style="font-size: 11px; color: #666; word-break: break-all; margin-bottom: 10px;">URL not generated yet</div>
        <button id="executeDownloadBtn" disabled>Download from S3</button>
    </div>

    <div class="card">
        <label>Console Logs</label>
        <div id="log"></div>
    </div>

    <script>
        const CHUNK_SIZE = 5 * 1024 * 1024;
        const BASE_URL = "http://localhost:9000/api/upload"; // Gateway URL

        let activeSession = null;
        let presignedUrl = null;

        const logDiv = document.getElementById('log');
        const progressBar = document.getElementById('progressBar');
        const uploadBtn = document.getElementById('uploadBtn');
        const executeDownloadBtn = document.getElementById('executeDownloadBtn');

        function logger(msg, type = 'default') {
            const div = document.createElement('div');
            div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            if (type === 'err') div.className = 'err';
            if (type === 'info') div.className = 'info';
            if (type === 'success') div.className = 'success';
            logDiv.prepend(div);
        }

        // --- HEALTH CHECK ---
        document.getElementById('healthBtn').onclick = async () => {
            const token = document.getElementById('token').value;
            try {
                const resp = await fetch(`${BASE_URL}/health`, {
                    headers: token ? { 'Authorization': `Bearer ${token}` } : {}
                });
                const text = await resp.text();
                logger(`Health: ${text}`, resp.ok ? 'success' : 'err');
            } catch (err) { logger(`Health check failed`, 'err'); }
        };

        // --- UPLOAD STAGE 1 ---
        document.getElementById('sessionBtn').onclick = async () => {
            const file = document.getElementById('fileInput').files[0];
            const token = document.getElementById('token').value;
            if (!file || !token) return alert("File and Token required");

            try {
                const resp = await fetch(`${BASE_URL}/session`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ file_name: file.name, file_size_bytes: file.size })
                });
                if (!resp.ok) throw new Error(`Status ${resp.status}`);
                activeSession = await resp.json();
                document.getElementById('sessionInfo').innerHTML = `Session ID: ${activeSession.upload_uuid}`;
                uploadBtn.disabled = false;
                logger(`Session Initialized: ${activeSession.upload_uuid}`, 'success');
            } catch (err) { logger(`Session error: ${err.message}`, 'err'); }
        };

        // --- UPLOAD STAGE 2 ---
        uploadBtn.onclick = async () => {
            const file = document.getElementById('fileInput').files[0];
            const token = document.getElementById('token').value;
            uploadBtn.disabled = true;
            try {
                for (let i = 0; i < activeSession.total_chunks; i++) {
                    const chunk = file.slice(i * CHUNK_SIZE, (i + 1) * CHUNK_SIZE);
                    const buffer = await chunk.arrayBuffer();
                    const hash = await crypto.subtle.digest('SHA-256', buffer);
                    const checksum = Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');

                    const resp = await fetch(`${BASE_URL}/chunk?id=${i}`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Upload-UUID': activeSession.upload_uuid,
                            'Checksum': checksum,
                            'Content-Type': 'application/octet-stream'
                        },
                        body: buffer
                    });
                    if (!resp.ok) throw new Error(`Chunk ${i} failed`);
                    progressBar.value = ((i + 1) / activeSession.total_chunks) * 100;
                }
                logger("Upload Complete!", 'success');
            } catch (err) { logger(err.message, 'err'); uploadBtn.disabled = false; }
        };

        // --- DOWNLOAD STAGE 1: GET URL ---
        document.getElementById('getDownloadUrlBtn').onclick = async () => {
            const fileId = document.getElementById('downloadFileId').value;
            const token = document.getElementById('token').value;
            if (!fileId || !token) return alert("File UUID and Token required");

            try {
                logger("Requesting S3 Download URL...", "info");
                // Calling /{fileID}/download as requested
                const resp = await fetch(`${BASE_URL}/${fileId}/download`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                
                const data = await resp.json(); // Assuming response: { "download_url": "s3-presigned-link..." }
                presignedUrl = data.download_url;
                
                document.getElementById('downloadUrlInfo').textContent = presignedUrl;
                executeDownloadBtn.disabled = false;
                logger("Presigned URL generated.", "success");
            } catch (err) {
                logger(`Download Init Error: ${err.message}`, "err");
            }
        };

        // --- DOWNLOAD STAGE 2: EXECUTE DOWNLOAD ---
        executeDownloadBtn.onclick = async () => {
            if (!presignedUrl) return;
            logger("Starting direct download from S3...", "info");
            
            try {
                // Using a traditional anchor link approach to force browser download
                const a = document.createElement('a');
                a.href = presignedUrl;
                // Note: 'download' attribute doesn't work cross-origin unless S3 headers allow it,
                // but the S3 presigned URL usually handles Content-Disposition anyway.
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                logger("Download triggered in browser.", "success");
            } catch (err) {
                logger(`Execution error: ${err.message}`, "err");
            }
        };
    </script>
</body>
</html>