<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoVault Multi-Stage Tester</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 650px; margin: 2rem auto; background-color: #f8f9fa; color: #333; }
        .card { background: white; padding: 20px; margin-bottom: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        input[type="text"], input[type="file"] { width: 100%; padding: 12px; margin-top: 8px; border: 1px solid #dfe3e6; border-radius: 6px; box-sizing: border-box; }
        
        .btn-group { display: flex; gap: 10px; margin-top: 15px; }
        button { flex: 1; padding: 14px; border-radius: 6px; cursor: pointer; font-weight: 600; border: none; transition: all 0.2s; }
        
        #healthBtn { background-color: #47cc40; color: white; }
        #sessionBtn, #getDownloadUrlBtn { background-color: #007bff; color: white; }
        #uploadBtn, #executeDownloadBtn { background-color: #238636; color: white; }
        
        button:disabled { background-color: #ccc !important; cursor: not-allowed; opacity: 0.6; }
        button:hover:not(:disabled) { opacity: 0.9; transform: translateY(-1px); }

        progress { width: 100%; height: 20px; margin-top: 10px; accent-color: #238636; }
        #log { background: #161b22; color: #d1d5da; padding: 15px; font-family: 'Cascadia Code', monospace; font-size: 12px; height: 220px; overflow-y: auto; border-radius: 6px; margin-top: 10px; border: 1px solid #30363d; }
        .err { color: #f85149; }
        .info { color: #79c0ff; }
        .success { color: #51cf66; }
        label { font-weight: 600; font-size: 14px; color: #444; }
        .step-label { display: inline-block; background: #eee; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-bottom: 5px; }
        hr { border: 0; border-top: 1px solid #eee; margin: 20px 0; }
    </style>
</head>
<body>

    <div class="card">
        <h2>GoVault Credentials</h2>
        <label>Access Token (JWT)</label>
        <input type="text" id="token" placeholder="Bearer token...">
        <div class="btn-group">
            <button id="healthBtn">Check Health</button>
        </div>
    </div>

    <div class="card">
        <h3>Upload Flow</h3>
        <span class="step-label">STAGE 1</span><br>
        <label>Select File</label>
        <input type="file" id="fileInput">
        <button id="sessionBtn">Initialize Session</button>
        <hr>
        <span class="step-label">STAGE 2</span><br>
        <div id="sessionInfo" style="font-size: 12px; color: #666; margin-bottom: 10px;">No active session</div>
        <button id="uploadBtn" disabled>Start Uploading Chunks</button>
        <progress id="progressBar" value="0" max="100"></progress>
    </div>

    <div class="card">
        <h3>Download Flow</h3>
        <span class="step-label">STAGE 1</span><br>
        <label>File UUID</label>
        <input type="text" id="downloadFileId" placeholder="Enter File UUID">
        <button id="getDownloadUrlBtn">Get Download Info</button>
        <hr>
        <span class="step-label">STAGE 2</span><br>
        <div id="downloadUrlInfo" style="font-size: 11px; color: #666; word-break: break-all; margin-bottom: 10px;">Metadata not fetched yet</div>
        <button id="executeDownloadBtn" disabled>Execute S3 Download</button>
    </div>

    <div class="card">
        <label>Console Logs</label>
        <div id="log"></div>
    </div>

    <script>
        const CHUNK_SIZE = 5 * 1024 * 1024;
        const GATEWAY_URL = "http://localhost:9000/api";
        const UPLOAD_URL = `${GATEWAY_URL}/upload`;
        const FILES_URL = `${GATEWAY_URL}/files`;

        let activeSession = null;
        let presignedUrl = null;

        const logDiv = document.getElementById('log');
        const progressBar = document.getElementById('progressBar');
        const uploadBtn = document.getElementById('uploadBtn');
        const executeDownloadBtn = document.getElementById('executeDownloadBtn');

        function logger(msg, type = 'default') {
            const div = document.createElement('div');
            div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            if (type === 'err') div.className = 'err';
            if (type === 'info') div.className = 'info';
            if (type === 'success') div.className = 'success';
            logDiv.prepend(div);
        }

        // --- HEALTH CHECK ---
        document.getElementById('healthBtn').onclick = async () => {
            const token = document.getElementById('token').value;
            try {
                const resp = await fetch(`${UPLOAD_URL}/health`, {
                    headers: token ? { 'Authorization': `Bearer ${token}` } : {}
                });
                const text = await resp.text();
                logger(`Health: ${text}`, resp.ok ? 'success' : 'err');
            } catch (err) { logger(`Health check failed`, 'err'); }
        };

        // --- UPLOAD STAGE 1 ---
        document.getElementById('sessionBtn').onclick = async () => {
            const file = document.getElementById('fileInput').files[0];
            const token = document.getElementById('token').value;
            if (!file || !token) return alert("File and Token required");

            try {
                const resp = await fetch(`${UPLOAD_URL}/session`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ file_name: file.name, file_size_bytes: file.size })
                });
                if (!resp.ok) throw new Error(`Status ${resp.status}`);
                activeSession = await resp.json();
                document.getElementById('sessionInfo').innerHTML = `Session ID: ${activeSession.upload_uuid}`;
                uploadBtn.disabled = false;
                logger(`Session Initialized: ${activeSession.upload_uuid}`, 'success');
            } catch (err) { logger(`Session error: ${err.message}`, 'err'); }
        };

        // --- UPLOAD STAGE 2 ---
        uploadBtn.onclick = async () => {
            const file = document.getElementById('fileInput').files[0];
            const token = document.getElementById('token').value;
            uploadBtn.disabled = true;
            try {
                for (let i = 0; i < activeSession.total_chunks; i++) {
                    const chunk = file.slice(i * CHUNK_SIZE, (i + 1) * CHUNK_SIZE);
                    const buffer = await chunk.arrayBuffer();
                    const hash = await crypto.subtle.digest('SHA-256', buffer);
                    const checksum = Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');

                    const resp = await fetch(`${UPLOAD_URL}/chunk?id=${i}`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Upload-UUID': activeSession.upload_uuid,
                            'Checksum': checksum,
                            'Content-Type': 'application/octet-stream'
                        },
                        body: buffer
                    });
                    if (!resp.ok) throw new Error(`Chunk ${i} failed`);
                    progressBar.value = ((i + 1) / activeSession.total_chunks) * 100;
                    logger(`Chunk ${i} uploaded`);
                }
                logger("Upload Complete!", 'success');
            } catch (err) { 
                logger(`Upload Failed: ${err.message}`, 'err'); 
                uploadBtn.disabled = false; 
            }
        };

        // --- DOWNLOAD STAGE 1: GET DOWNLOAD INFO ---
        document.getElementById('getDownloadUrlBtn').onclick = async () => {
            const fileId = document.getElementById('downloadFileId').value;
            const token = document.getElementById('token').value;
            if (!fileId || !token) return alert("File UUID and Token required");

            try {
                logger("Fetching download metadata from Files Service...", "info");
                
                // Matches Handler: GET /api/files/{fileID}/download
                const resp = await fetch(`${FILES_URL}/${fileId}/download`, {
                    method: 'GET',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                
                const data = await resp.json(); 
                
                // If your service generates a URL, use data.download_url
                // If it just gives key, use data.storage_key (browser can't download key directly without signing)
                presignedUrl = data.download_url || data.storage_key; 
                
                document.getElementById('downloadUrlInfo').innerHTML = `
                    <strong>Target:</strong> ${presignedUrl}<br>
                    <strong>Expires:</strong> ${data.expires_at || 'N/A'}
                `;
                
                executeDownloadBtn.disabled = false;
                logger("Download metadata received.", "success");
            } catch (err) {
                logger(`Download Meta Error: ${err.message}`, "err");
            }
        };

        // --- DOWNLOAD STAGE 2: EXECUTE ---
        executeDownloadBtn.onclick = async () => {
            if (!presignedUrl) return;
            logger("Redirecting to S3 Source...", "info");
            
            try {
                // If presignedUrl is a valid HTTPS link, this triggers the download
                window.open(presignedUrl, '_blank');
                logger("Download triggered.", "success");
            } catch (err) {
                logger(`Execution error: ${err.message}`, "err");
            }
        };
    </script>
</body>
</html>