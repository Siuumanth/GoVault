<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GoVault Multi-Stage Tester</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 750px; margin: 2rem auto; background-color: #f4f6f8; color: #333; }
        .card { background: white; padding: 25px; margin-bottom: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: 1px solid #e1e4e8; }
        input, select { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px; }
        .btn-init { background: #007bff; color: white; }
        .btn-start { background: #238636; color: white; }
        button { width: 100%; padding: 14px; border-radius: 6px; cursor: pointer; font-weight: 600; border: none; margin-top: 10px; }
        button:disabled { background: #ccc !important; cursor: not-allowed; }
        #log { background: #1e1e1e; color: #d1d5da; padding: 15px; font-family: 'Cascadia Code', monospace; height: 300px; overflow-y: auto; border-radius: 6px; font-size: 12px; line-height: 1.5; }
        .err { color: #f85149; }
        .success { color: #7ee787; }
        .info { color: #79c0ff; }
        progress { width: 100%; height: 20px; margin-top: 15px; border-radius: 10px; }
    </style>
</head>
<body>

    <div class="card">
        <h2>1. Auth & Config</h2>
        <label>Bearer Token</label>
        <input type="text" id="token" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
        
        <label>Upload Strategy</label>
        <select id="uploadMethod">
            <option value="proxy">Backend Proxy (5MB Chunks)</option>
            <option value="multipart">S3 Multipart (100MB Parts)</option>
        </select>
    </div>

    <div class="card">
        <h2>2. File Selection</h2>
        <input type="file" id="fileInput">
        <button id="sessionBtn" class="btn-init">Initialize Session</button>
        <progress id="progressBar" value="0" max="100"></progress>
        <button id="uploadBtn" class="btn-start" disabled>Start Upload Sequence</button>
    </div>

    <div class="card">
        <h3>System Logs</h3>
        <div id="log"></div>
    </div>

    <script>
        /** --- CONFIGURATION --- **/
        const PROXY_CHUNK_SIZE = 5 * 1024 * 1024; 
        const S3_PART_SIZE = 100 * 1024 * 1024;
        const BASE_URL = "http://localhost:9000/api/upload";

        /** --- STATE --- **/
        let session = null;
        const ui = {
            log: (msg, type = '') => {
                const div = document.createElement('div');
                div.className = type;
                div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
                document.getElementById('log').prepend(div);
                console.log(`[${type.toUpperCase() || 'LOG'}]`, msg);
            },
            progress: (val) => document.getElementById('progressBar').value = val,
            setBtn: (id, enabled) => document.getElementById(id).disabled = !enabled
        };

        /** --- API CLIENT --- **/
        const API = {
            async request(endpoint, options = {}) {
                const token = document.getElementById('token').value;
                const headers = {
                    'Authorization': `Bearer ${token}`,
                    ...options.headers
                };

                const response = await fetch(`${BASE_URL}${endpoint}`, { ...options, headers });
                const text = await response.text();
                
                // Log all responses for debugging
                console.log(`API Response (${endpoint}):`, { status: response.status, body: text });

                if (!response.ok) throw new Error(text || `Status ${response.status}`);
                
                try {
                    return JSON.parse(text);
                } catch (e) {
                    return text; // Return raw text if not JSON
                }
            }
        };

        /** --- EVENT HANDLERS --- **/

        // 1. Initialize Session
        document.getElementById('sessionBtn').onclick = async () => {
            const file = document.getElementById('fileInput').files[0];
            const method = document.getElementById('uploadMethod').value;
            if (!file) return alert("Select a file");

            try {
                ui.log(`Initializing ${method} session...`, 'info');
                
                const isMultipart = method === 'multipart';
                const endpoint = isMultipart ? '/multipart/session' : '/proxy/session';
                
                // DTO Mapping: Matches your Go struct JSON tags exactly
                const payload = isMultipart ? {
                    file_name: file.name,
                    file_size_bytes: file.size,
                    part_size_bytes: S3_PART_SIZE
                } : {
                    file_name: file.name,
                    file_size_bytes: file.size
                };

                session = await API.request(endpoint, {
                    method: 'POST',
                    body: JSON.stringify(payload),
                    headers: { 'Content-Type': 'application/json' }
                });

                ui.log(`Session Created: ${session.upload_uuid}`, 'success');
                ui.log(`Total Parts expected: ${session.total_chunks}`, 'info');
                
                session.method = method;
                session.partSize = isMultipart ? S3_PART_SIZE : PROXY_CHUNK_SIZE;
                
                ui.setBtn('uploadBtn', true);
            } catch (err) {
                ui.log(`Init Failed: ${err.message}`, 'err');
            }
        };

        // 2. Upload Execution
        document.getElementById('uploadBtn').onclick = async () => {
            const file = document.getElementById('fileInput').files[0];
            ui.setBtn('uploadBtn', false);
            ui.progress(0);

            try {
                const total = parseInt(session.total_chunks);
                
                for (let i = 0; i < total; i++) {
                    const start = i * session.partSize;
                    const end = Math.min(start + session.partSize, file.size);
                    const blob = file.slice(start, end);

                    if (session.method === 'proxy') {
                        await handleProxyChunk(blob, i);
                    } else {
                        await handleS3Part(blob, i + 1); // S3 is 1-indexed
                    }

                    ui.progress(((i + 1) / total) * 100);
                }

                if (session.method === 'multipart') {
                    ui.log("Finalizing S3 Multipart assembly...", "info");
                    await API.request('/multipart/complete', {
                        method: 'POST',
                        body: JSON.stringify({ upload_uuid: session.upload_uuid }),
                        headers: { 'Content-Type': 'application/json' }
                    });
                }

                ui.log("ðŸ”¥ ALL OPERATIONS COMPLETE", "success");
            } catch (err) {
                ui.log(`Critical Failure: ${err.message}`, 'err');
                ui.setBtn('uploadBtn', true);
            }
        };

        /** --- CORE UPLOAD LOGIC --- **/

        async function handleProxyChunk(blob, index) {
            // Checksum calculation (required by your backend code)
            const buffer = await blob.arrayBuffer();
            const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
            const checksum = Array.from(new Uint8Array(hashBuffer))
                .map(b => b.toString(16).padStart(2, '0')).join('');

            await API.request(`/proxy/chunk?id=${index}`, {
                method: 'POST',
                body: buffer,
                headers: {
                    'Upload-UUID': session.upload_uuid,
                    'Checksum': checksum,
                    'Content-Type': 'application/octet-stream'
                }
            });
            ui.log(`Chunk ${index} verified and stored.`);
        }

        async function handleS3Part(blob, partNumber) {
            // Here you would normally upload directly to S3. 
            // We simulate the ETag return and record it in your backend.
            const mockETag = `"${Math.random().toString(16).slice(2)}"`;
            
            await API.request('/multipart/part', {
                method: 'POST',
                body: JSON.stringify({
                    upload_uuid: session.upload_uuid,
                    part_number: partNumber,
                    size_bytes: blob.size,
                    etag: mockETag
                }),
                headers: { 'Content-Type': 'application/json' }
            });
            ui.log(`Part ${partNumber} recorded in DB.`);
        }
    </script>
</body>
</html>